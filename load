#!/usr/bin/env ruby

require 'yaml'
require 'dbus'

$data = YAML.load(File.read(ARGV[0]))
$xfconf = DBus.session_bus['org.xfce.Xfconf']['/org/xfce/Xfconf']['org.xfce.Xfconf']

def set(channel, key, value, base: nil)
  key = base + '/' + key if base
  puts "#{channel}:#{key} = #{value}"
  $xfconf.SetProperty(channel, key, value)
end

def set_each(channel, list, base: nil)
  list.each do |key,value|
    set(channel, key, value, base: base)
  end
end

# General settings
if settings = $data['settings']
  settings.each do |channel,list|
    set_each(channel, list)
  end
end

if shortcuts = $data['shortcuts']

  # Command keyboard shortcuts
  if commands = shortcuts['commands']
    set_each('xfce4-keyboard-shortcuts', commands, base: '/commands/custom')
  end

  # WM keyboard shortcuts
  if actions = shortcuts['wm']
    actions = actions.invert.transform_values { |action| action + '_key' }
    set_each('xfce4-keyboard-shortcuts', actions, base: '/xfwm4/custom')
  end

end

# Panels
if panels = $data['panels']
  channel = 'xfce4-panel'
  base = '/panels'

  $xfconf.ResetProperty(channel, '/panels', true)
  $xfconf.ResetProperty(channel, '/plugins', true)

  panels.each_with_index do |panel,panel_id|
    plugins = panel.delete('plugins')
    plugins.each_with_index do |(name,params),plugin_id|
      plugin_base = "/plugins/plugin-#{plugin_id + 1}"

      set(channel, plugin_base, name)
      next unless params

      set_each(channel, params, base: plugin_base)
    end

    panel['plugin-ids'] = (1..plugins.length).to_a
    panel_base = "/panels/panel-#{panel_id + 1}"
    set_each(channel, panel, base: panel_base)
  end

  value = (1..panels.length).to_a
  set(channel, base, value)

  system('xfce4-panel', '--restart')
end
