#!/usr/bin/env ruby

require 'yaml'
require 'dbus'

$data = YAML.load(File.read(ARGV[0]))
$xfconf = DBus.session_bus['org.xfce.Xfconf']['/org/xfce/Xfconf']['org.xfce.Xfconf']

def set(channel, key, value, base: nil)
  key = base + '/' + key if base
  puts "#{channel}:#{key} = #{value}"
  $xfconf.SetProperty(channel, key, value)
end

# General settings
if settings = $data['settings']
  settings.each do |channel,list|
    list.each do |key, value|
      set(channel, key, value)
    end
  end
end

if shortcuts = $data['shortcuts']

  # Command keyboard shortcuts
  if commands = shortcuts['commands']
    channel = 'xfce4-keyboard-shortcuts'
    base = '/commands/custom'

    commands.each do |shortcut,command|
      set(channel, shortcut, command, base: base)
    end
  end

  # WM keyboard shortcuts
  if actions = shortcuts['wm']
    channel = 'xfce4-keyboard-shortcuts'
    base = '/xfwm4/custom'

    actions.each do |action,shortcut|
      action += '_key'
      set(channel, shortcut, action, base: base)
    end
  end

end

# Panels
if panels = $data['panels']
  channel = 'xfce4-panel'
  base = '/panels'

  $xfconf.ResetProperty(channel, '/panels', true)
  $xfconf.ResetProperty(channel, '/plugins', true)

  panels.each_with_index do |panel,panel_id|
    plugins = panel.delete('plugins')
    plugins.each_with_index do |(name,params),plugin_id|
      plugin_base = "/plugins/plugin-#{plugin_id + 1}"

      set(channel, plugin_base, name)
      next unless params

      params.each do |param,value|
        set(channel, param, value, base: plugin_base)
      end
    end

    panel_base = "/panels/panel-#{panel_id + 1}"

    panel['plugin-ids'] = (1..plugins.length).to_a
    panel.each do |key,value|
      set(channel, key, value, base: panel_base)
    end
  end

  value = (1..panels.length).to_a
  set(channel, base, value)

  system('xfce4-panel', '--restart')
end
